<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../js/flexible.js"></script>
    <script src="../js/mui.min.js"></script>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/mui.min.css">
    <link rel="stylesheet" href="../css/personalInformation.css">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>个人信息</title>
</head>

<body>
    <div class="action-bar-no-search">
        <div class="title-left mui-action-back">
            <div>
                <span class="mui-icon mui-icon-back">

                </span>
                <span>

                </span>
            </div>
        </div>
        <div class="title-center">
            个人信息
        </div>
        <div class="title-right">
            <div class="title-right-left">
                <img src="" />
            </div>
            <div class="title-right-right">
                <img src="" alt="">
            </div>
        </div>
    </div>
    <div class="container" id="app">
        <div id="picture-btn" class="user-header">
            <div class="text">
                上传头像
            </div>
            <div class="select-img">
                <img v-if="!userMessage.headimg" src="../img/userHeader.png" alt="">
                <img v-if="userMessage.headimg" id="user-header-img" v-bind:src="http_url+userMessage.headimg" alt="">
                <span class="mui-icon mui-icon-arrowright">

                </span>
            </div>
        </div>
        <div class="common-list">
            <div>
                <span>登录名：</span>
            </div>
            <span class="account-number">{{userMessage.phone}}</span>
        </div>
        <div class="common-list">
            <div>
                <span>昵称：</span>
            </div>
            <input v-model="nickname" type="text">
        </div>
        <div class="common-list">
            <div>
                <span>姓名：</span>
            </div>
            <input v-model="truename" type="text">
        </div>
        <div class="common-list">
            <div>
                <span>
                    性别：
                </span>
            </div>
            <div class="mui-input-row mui-radio">
                <label>男</label>
                <input type="radio" style="top: 8px;right: 12px" name="sex" value="男" v-model="sex">
            </div>
            <div class="mui-input-row mui-radio">
                <label>女</label>
                <input type="radio" style="top: 8px;right: 12px" name="sex" value="女" v-model="sex">
            </div>
        </div>
        <div id="birtady" class="common-list">
            <div>
                <span>生日：</span>
            </div>
            <span class="account-number">{{birthday}}</span>
            <span class="mui-icon mui-icon-arrowright float-right"></span>
        </div>
        <div class="submit-button" @tap="submit()">
            保存
        </div>
    </div>
    <script src="../js/md5.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/vue.min.js"></script>
    <script>
        mui.ajax(http_url + "/api.php/User/info?token=" + user_all_message.token, {
            dataType: 'json',
            type: 'get',
            timeout: 10000,
            headers: { 'Content-Type': 'application/json', "apitoken": c('/api.php/User/info'), },
            success: function (data) {
                vm.userMessage = data.data;
                vm.sex = data.data.sex;
                vm.truename = data.data.truename;
                vm.birthday = data.data.birthday;
                vm.nickname = data.data.nickname;
            },
            error: function (xhr, type, errorThrown) {
                //异常处理；ss
                console.log(errorThrown);
            }
        })
        var vm = new Vue({
            el: "#app",
            data: {
                userMessage: {},
                truename: "",
                nickname: "",
                birthday: "",
                sex: "",
            }
        })
        var myPage;
        function plusReady() {
            myPage = plus.webview.getWebviewById("my.html");
        }
        if (window.plus) {
            plusReady();
        } else {
            document.addEventListener("plusready", plusReady, false);
        }
        mui(".container").on("tap", "#birtady", function () {
            pickDate(this);
        })
        // 选择日期
        function pickDate(data) {
            plus.nativeUI.pickDate(function (e) {
                var d = e.date;
                vm.birthday = d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate();
                //    Vue.set(vm,birthday,d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate())
            }, function (e) {
                console.log("未选择日期：" + e.message);
            });
        }
        //获取用户头像img
        var user_header_img = document.getElementById("user-header-img");
        //弹出选择按钮框
        document.getElementById("picture-btn").addEventListener('tap', function () {
            var btnArray = [{ title: "拍照" }, { title: "从相册选取" }];
            plus.nativeUI.actionSheet({
                title: "选择照片",
                cancel: "取消",
                buttons: btnArray
            }, function (e) {
                var index = e.index;
                console.log(JSON.stringify(e));
                switch (index) {
                    case 0:
                        break;
                    case 1:
                        camera();
                        break;
                    case 2:
                        galleryImg();
                        break;
                }
            });
        });
        //原生toast
        function toast(message) {
            plus.nativeUI.toast(message, { verticalAlign: "center" });
        }
        //调用相机的方法
        function camera() {
            var cmr = plus.camera.getCamera();
            var res = cmr.supportedImageResolutions[0];
            var fmt = cmr.supportedImageFormats[0];
            cmr.captureImage(function (path) {
                localPicture = path;
                plus.io.resolveLocalFileSystemURL(path, function (entry) {
                    var src = entry.toLocalURL();
                    user_header_img.src = src;
                    createUpload();
                })
            },
                function (error) {
                    console.log(JSON.stringify(error));
                },
                { resolution: res, format: fmt }
            );
        }
        var localPicture;
        //调用相册的方法
        // 从相册中选择图片 
        function galleryImg() {
            // 从相册中选择图片
            plus.gallery.pick(function (path) {
                localPicture = path;
                plus.io.resolveLocalFileSystemURL(path, function (entry) {
                    var src = entry.toLocalURL();
                    user_header_img.src = src;
                    createUpload();
                })
            }, function (e) {
                console.log("取消选择图片");
            }, { filter: "image" });
        }
        //保存用户信息
        function submit() {
            console.log(vm.nickname);
            mui.ajax(http_url + '/api.php/User/info?token=' + user_all_message.token, {
                data: {
                    nickname: vm.nickname,
                    truename: vm.truename,
                    sex: vm.sex,
                    birthday: vm.birthday,
                },
                dataType: 'json',
                type: 'post',
                headers: { "apitoken": c('/api.php/User/info'), },
                timeout: 10000,
                success: function (data) {
                    console.log(JSON.stringify(data));
                    myPage.reload(true);
                    mui.back();
                },
                error: function (xhr, type, errorThrown) {

                }
            });
        }
        //上传头像
        function createUpload() {
            var task = plus.uploader.createUpload(http_url + "/api.php/User/upload_attachment",
                { method: "POST", blocksize: 204800, priority: 100 },
                function (t, status) {
                    // 上传完成
                    if (status == 200) {
                        console.log(JSON.stringify(t))
                    } else {

                    }
                }
            );
            task.addFile(user_header_img.src, { key: "fileupload" });
            task.setRequestHeader('apitoken', c('/api.php/User/upload_attachment'));
            // task.addData("fileupload", user_header_img.src);
            task.start();
        }
    </script>
</body>

</html>